<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>HanApp | Provider Inbox</title>
    <link rel="stylesheet" href="messages.css" />
    <style>body{font-family:Arial,Helvetica,sans-serif;margin:0;background:#f7f9fb}.header{display:flex;align-items:center;justify-content:space-between;padding:12px 20px;background:#fff;border-bottom:1px solid #eee} .nav a{margin-left:12px;color:#333;text-decoration:none}</style>
  </head>
  <body>
    <header class="header">
      <div>
        <img src="/assets/logo.png" alt="HanApp" height="34" />
      </div>
      <nav class="nav">
        <a href="accountinfo.html">Account</a>
        <a href="bookservice.html">Book Service</a>
        <a href="bookinghistory.html">Bookings</a>
        <a href="settings.html">Settings</a>
        <a href="landingpage.html">Home</a>
      </nav>
    </header>

    <main style="padding:20px;max-width:960px;margin:0 auto">
      <h1>Provider Inbox</h1>
      <p style="color:#666">This view lets a provider read messages from customers — open a conversation by entering the provider id and customer id.</p>

      <div style="margin-bottom:12px">
        <label>Provider id: <input id="providerId" type="number" style="width:80px" /></label>
        <label style="margin-left:12px">Customer id: <input id="custId" type="number" style="width:80px" /></label>
        <button id="openConv">Open</button>
      </div>

      <div id="chatRoot" style="display:none">
        <div id="messagesBox" style="height:320px;overflow:auto;border:1px solid #ddd;padding:12px;background:#fff;border-radius:6px"></div>
        <form id="sendForm" style="display:flex;margin-top:10px">
          <input id="msgInput" placeholder="Write a message to customer" style="flex:1;padding:8px;border:1px solid #ddd;border-radius:4px" />
          <button type="submit" style="margin-left:8px;padding:8px 12px">Send</button>
        </form>
      </div>

      <div id="status" style="margin-top:10px;color:#a00"></div>
    </main>

    <script>
      const providerEl = document.getElementById('providerId');
      const custEl = document.getElementById('custId');
      const openBtn = document.getElementById('openConv');
      const chatRoot = document.getElementById('chatRoot');
      const messagesBox = document.getElementById('messagesBox');
      const sendForm = document.getElementById('sendForm');
      const msgInput = document.getElementById('msgInput');
      const status = document.getElementById('status');

      function showError(e){ status.textContent = e; }

      let polling = null;

      async function loadMessages(providerId, custId){
        messagesBox.innerHTML = '<p style="color:#888">Loading…</p>';
        try{
          const res = await fetch(`/api/fetch_messages?u=${providerId}&other=${custId}`);
          if(!res.ok) throw new Error('Could not fetch');
          const data = await res.json();
          messagesBox.innerHTML = '';
          data.forEach(m=>{
            const el=document.createElement('div');
            el.style.padding='6px';el.style.marginBottom='6px';el.style.borderRadius='6px';
            if(m.sender_id==providerId){ el.style.background='#def7e2'; el.style.textAlign='right'; } else el.style.background='#fff';
            el.textContent = (m.message||'') + ' — ' + new Date(m.created_at).toLocaleString();
            messagesBox.appendChild(el);
          });
          messagesBox.scrollTop = messagesBox.scrollHeight;
        }catch(err){ console.error(err); showError(err.message||'Error'); }
      }

      openBtn.addEventListener('click',()=>{
        status.textContent=''; const providerId = parseInt(providerEl.value,10); const custId = parseInt(custEl.value,10);
        if(!providerId || !custId){ showError('Enter provider and customer ids'); return; }
        chatRoot.style.display='block'; loadMessages(providerId,custId);
        if(polling) clearInterval(polling);
        polling=setInterval(()=>loadMessages(providerId,custId),2500);

        sendForm.onsubmit = async (e)=>{
          e.preventDefault(); const text = msgInput.value.trim(); if(!text) return;
          try{
            const resp = await fetch('/api/send_message',{ method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ sender_id:providerId, receiver_id:custId, message:text }) });
            if(!resp.ok) throw new Error((await resp.json()).error||'Send failed');
            msgInput.value=''; loadMessages(providerId,custId);
          }catch(err){ showError(err.message||'Send error'); }
        };
      });
    </script>
  </body>
</html>