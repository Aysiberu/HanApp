<!doctype html>
<html lang="en"><head><meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/><title>Provider — Add profile photo</title>
<style>body{font-family:Arial,Helvetica,sans-serif;margin:0;padding:20px;background:#f7f9fb}.card{max-width:700px;margin:18px auto;padding:18px;background:#fff;border-radius:6px;border:1px solid #ddd}</style>
</head><body>
  <div class="card">
    <h1>Add your profile picture</h1>
    <p>This image will be shown when customers browse your profile — square preview will be used and image will automatically adapt.</p>

    <form id="avatarForm">
      <input type="hidden" id="providerId" />
      <input type="hidden" id="userId" />
      <input id="avatarFile" type="file" accept="image/*" required />
      <div style="margin-top:12px"><img id="preview" style="width:160px;height:160px;object-fit:cover;border-radius:8px;border:1px solid #ccc" /></div>
      <div style="margin-top:12px">
        <button type="submit">Upload & Finish</button>
      </div>
      <div id="msg" style="color:#a00;margin-top:8px;display:none"></div>
    </form>
  </div>

  <script>
    const q=new URLSearchParams(location.search); document.getElementById('providerId').value=q.get('providerId')||''; document.getElementById('userId').value=q.get('userId')||'';
    const fEl=document.getElementById('avatarFile'); const pr=document.getElementById('preview');
    fEl.addEventListener('change', ()=>{ const f=fEl.files[0]; if(!f) return; const r=new FileReader(); r.onload=()=>pr.src=r.result; r.readAsDataURL(f); });

    document.getElementById('avatarForm').addEventListener('submit', async (e)=>{
      e.preventDefault(); const msg=document.getElementById('msg'); msg.style.display='none';
      const f=fEl.files[0]; if(!f) { msg.style.display='block'; msg.textContent='Please pick a file'; return; }
      const reader=new FileReader(); reader.onload=async ()=>{
        try{
          const base = reader.result; const fn = f.name.replace(/[^a-z0-9.\-]/gi,'_'); const userId=document.getElementById('userId').value || 'unknown';
          const up = await fetch('/api/upload_image', { method:'POST', headers:{ 'Content-Type':'application/json' }, body: JSON.stringify({ filename: fn, base64: base, path: `providers/${userId}`, contentType: f.type }) });
          const j = await up.json(); if(!up.ok) throw new Error(j.error||'Upload failed');
          const url = j.url; const providerId=document.getElementById('providerId').value || null;
          // call provider_update to set profile photo
          const resp = await fetch('/api/provider_update', { method:'POST', headers:{ 'Content-Type':'application/json' }, body: JSON.stringify({ providerId: providerId || null, userId: userId || null, profile_photo_url: url }) });
          const body = await resp.json(); if(!resp.ok) throw new Error(body.error||'Could not set profile photo');
          alert('Profile photo uploaded. You are ready to be discovered as a provider.'); window.location.href = '/landingpage.html';
        }catch(err){ msg.style.display='block'; msg.textContent = err.message || 'Error'; }
      };
      reader.readAsDataURL(f);
    });
  </script>
</body></html>
